```{r foresthr, cache=cacheon}

foresthr <- function(treatvar, treatlab, novar, treatlabs = c("dose >= 50%", "dose < 50%", "not treated"), adj = FALSE) {
  modvarstmp <- modvarsnsstrata[!modvarsnsstrata %in% c("shf_bpsys", novar)]

  if (!adj) {
    # crude
    moduni <- coxph(formula(paste0("Surv(sos_outtime_hosphf, sos_out_deathcvhosphf == 'Yes') ~ ", treatvar)), data = pdata)
    modunis <- summary(moduni)
    loghr <- c(0, modunis$coefficients[, 1])
    loglci <- c(0, log(modunis$conf.int[, 3]))
    loguci <- c(0, log(modunis$conf.int[, 4]))
  }
  if (adj) {
    # adjusted
    modm <- with(impdata, coxph(formula(paste0(
      "Surv(sos_outtime_hosphf, sos_out_deathcvhosphf == 'Yes') ~ ", treatvar, " + ", paste(modvarstmp, collapse = " + ")
    ))))

    # df the number of events minus the regression coefficients.
    # There is support for this from middle of page 149 of the book by Parmer & Machin (ISBN 0471936405)
    modms <- summary(pool(modm,
      dfcom = (modm$analyses[[1]]$nevent - length(modm$analyses[[1]]$coefficients))
    ))

    nc <- length(levels(pdata %>% pull(!!sym(treatvar)))) - 1
    loghr <- c(0, modms$estimate[1:nc])
    loglci <- c(0, modms$estimate[1:nc] - global_z05 * modms$std.error[1:nc])
    loguci <- c(0, modms$estimate[1:nc] + global_z05 * modms$std.error[1:nc])
  }

  # %
  percent <- pdata %>%
    count(!!sym(treatvar)) %>%
    mutate(per = paste0(dF(n / sum(n) * 100, 1), "%")) %>%
    pull(per)

  labs1 <- rep(c(">=140 mmHg", "120-139 mmHg", "100-119 mmHg", "90-99 mmHg", "<90 mmHg"), each = length(treatlabs))
  labs2 <- rep(treatlabs, 5)

  hrci <- paste0(
    dF(exp(loghr), 1), " (",
    dF(exp(loglci), 1), "-",
    dF(exp(loguci), 1), ")"
  )
  hrci[1] <- "ref"

  outforest <- data.frame(cbind(labs1, labs2, loghr, loglci, loguci, hrci, percent))

  if (length(treatlabs) == 3) {
    outforest <- rbind(
      outforest[1:3, ], rep(NA, 6),
      outforest[4:6, ], rep(NA, 6),
      outforest[7:9, ], rep(NA, 6),
      outforest[10:12, ], rep(NA, 6),
      outforest[13:15, ]
    )
  }
  if (length(treatlabs) == 2) {
    outforest <- rbind(
      outforest[1:2, ], rep(NA, 6),
      outforest[3:4, ], rep(NA, 6),
      outforest[5:6, ], rep(NA, 6),
      outforest[7:8, ], rep(NA, 6),
      outforest[9:10, ]
    )
  }
  outforest <- outforest %>% arrange(desc(row_number()))

  nf <- nrow(outforest)
  # exp(min(loglci, na.rm = T))
  # exp(max(loguci, na.rm = T))

  # c(bottom, left, top, right)
  par(mar = c(2, 20, 1, 2) + 0.2)

  cextext <- 0.9

  if (!adj) {
    minx <- 0.9
    maxx <- 8
  }
  if (adj) {
    minx <- 0.9
    maxx <- 5
  }

  plot(outforest$loghr, 1:nf,
    cex = 1.2,
    xlim = c(
      log(minx),
      log(maxx)
    ),
    xlab = NA,
    ylim = c(1, nf + .6),
    axes = FALSE,
    ylab = NA,
    main = NA,
    type = "p",
    pch = 22,
    bg = global_kicols[1],
    col = global_kicols[1]
  )

  for (i in 1:nf) {
    lines(c(outforest$loglci[i], outforest$loguci[i]), c(i, i),
      col = global_kicols[1], cex = 2
    )
  }

  matplot(c(log(1), log(1)), c(-1, nf + 1), type = "l", lwd = 1, lty = 1, add = TRUE, col = 1)

  atmy <- c(seq(0.5, maxx, 0.5))
  atmy2 <- atmy
  atmy2[!atmy %in% c(1, 2, 3, 4, 5, 6, 7, 8)] <- NA
  axis(1,
    cex.axis = cextext, at = log(atmy),
    labels = atmy2
  )
  if (adj) {
    axis(1,
      cex.axis = cextext, at = log(c(1)),
      labels = c(1)
    )
  }
  if (!adj) {
    axis(1,
      cex.axis = cextext, at = log(c(1, 6, 8)),
      labels = c(1, 6, 8)
    )
  }

  axis(2,
    at = 1:(nf + 1),
    labels = c(outforest$labs2, treatlab),
    cex.axis = cextext, tick = FALSE, las = 2, line = 12, hadj = 0
  )
  axis(2,
    at = c(seq(length(treatlabs) / 2 + .5, (length(treatlabs) + 1) * 5, length(treatlabs) + 1), nf + 1),
    labels = c(unique(rev(labs1)), "SBP"),
    cex.axis = cextext, tick = FALSE, las = 2, line = 19, hadj = 0
  )

  axis(2,
    at = c(1:(nf + 1)),
    labels = c(outforest$percent, "% patients"),
    cex.axis = cextext, tick = FALSE, las = 2, line = 5.5, hadj = 0.5
  )

  axis(2,
    at = c(1:(nf + 1)),
    labels = c(outforest$hrci, "HR (95% CI)"),
    cex.axis = cextext, tick = FALSE, las = 2, line = 1, hadj = 0.5
  )
}
```

```{r forestuniras, fig.cap="Crude Forestplot - association between systolic blood pressure/ras and CVD/First HFH", dependson="foresthr", cache=cacheon}
foresthr(treatvar = "sysbp_ras", novar = "shf_ras", treatlab = "RASi", treatlabs = c("dose >= 50%", "dose < 50%", "not treated"), adj = FALSE)
```

```{r forestadjras, fig.cap="Adjusted Forestplot - association between systolic blood pressure/ras and CVD/First HFH", dependson="foresthr", cache=cacheon}

foresthr("sysbp_ras", novar = "shf_ras", treatlab = "RASi", treatlabs = c("dose >= 50%", "dose < 50%", "not treated"), adj = TRUE)
```

```{r forestunibbl, fig.cap="Crude Forestplot - association between systolic blood pressure/bbl and CVD/First HFH", dependson="foresthr", cache=cacheon}
foresthr("sysbp_bbl", novar = "shf_bbl", treatlab = "Bbl", treatlabs = c("dose >= 50%", "dose < 50%", "not treated"), adj = FALSE)
```

```{r forestadjbbl, fig.cap="Adjusted Forestplot - association between systolic blood pressure/bbl and CVD/First HFH", dependson="foresthr", cache=cacheon}

foresthr(treatvar = "sysbp_bbl", treatlab = "Bbl", novar = "shf_bbl", treatlabs = c("dose >= 50%", "dose < 50%", "not treated"), adj = TRUE)
```

```{r forestunimra, fig.cap="Crude Forestplot - association between systolic blood pressure/mra and CVD/First HFH", dependson="foresthr", cache=cacheon}
foresthr(treatvar = "sysbp_mra", treatlab = "MRA", novar = "shf_mra", treatlabs = c("treated", "not treated"), adj = FALSE)
```

```{r forestadjmra, fig.cap="Adjusted Forestplot - association between systolic blood pressure/mra and CVD/First HFH", dependson="foresthr", cache=cacheon}

foresthr("sysbp_mra", novar = "shf_mra", treatlab = "MRA", treatlabs = c("treated", "not treated"), adj = TRUE)
```
